name: Deploy to Production

on:
  push:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
      - 'LICENSE'
  workflow_dispatch:

env:
  REGISTRY: docker.io
  IMAGE_TAG: ${{ github.sha }}

jobs:
  # ==========================================
  # Detect Changes - Bygg bara vad som √§ndrats
  # ==========================================
  detect-changes:
    name: Detect Changes
    runs-on: self-hosted
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check for changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            backend:
              - 'apps/backend/**'
              - '**/pom.xml'
            frontend:
              - 'apps/frontend/**'
              - '**/package.json'
              - '**/vite.config.ts'

  # ==========================================
  # Build Backend
  # ==========================================
  build-backend:
    name: Build Backend
    runs-on: self-hosted
    needs: detect-changes
    if: needs.detect-changes.outputs.backend == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'
      
      - name: Set execute permission for Maven wrapper
        run: chmod +x apps/backend/blitzduel/mvnw
      
      - name: Build with Maven
        run: |
          cd apps/backend/blitzduel
          ./mvnw clean package -DskipTests -B -Dproject.build.sourceEncoding=UTF-8
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: ./apps/backend/blitzduel
          push: true
          platforms: linux/arm64
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/blitzduel-backend:latest
            ${{ secrets.DOCKER_USERNAME }}/blitzduel-backend:${{ env.IMAGE_TAG }}
          cache-from: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/blitzduel-backend:buildcache
          cache-to: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/blitzduel-backend:buildcache,mode=max

  # ==========================================
  # Build Frontend
  # ==========================================
  build-frontend:
    name: Build Frontend
    runs-on: self-hosted
    needs: detect-changes
    if: needs.detect-changes.outputs.frontend == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: apps/frontend/blitzduel/package-lock.json
      
      - name: Install dependencies
        run: |
          cd apps/frontend/blitzduel
          npm ci
      
      - name: Build application
        run: |
          cd apps/frontend/blitzduel
          npm run build
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: ./apps/frontend/blitzduel
          push: true
          platforms: linux/arm64
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/blitzduel-frontend:latest
            ${{ secrets.DOCKER_USERNAME }}/blitzduel-frontend:${{ env.IMAGE_TAG }}
          cache-from: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/blitzduel-frontend:buildcache
          cache-to: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/blitzduel-frontend:buildcache,mode=max

  # ==========================================
  # Deploy to Production
  # ==========================================
  deploy:
    name: Deploy to Raspberry Pi
    runs-on: self-hosted
    needs: [detect-changes, build-backend, build-frontend]
    if: always() && !failure() && !cancelled()
    env:
      BACKEND_CHANGED: ${{ needs.detect-changes.outputs.backend }}
      FRONTEND_CHANGED: ${{ needs.detect-changes.outputs.frontend }}
    steps:
      - name: Deploy
        run: |
          set -e
          
          cd ~/blitzduel
          
          # Set IMAGE_TAG to latest explicitly
          export IMAGE_TAG=latest
          
          echo "üì¶ Starting deployment..."
          echo "Backend changed: $BACKEND_CHANGED"
          echo "Frontend changed: $FRONTEND_CHANGED"
          
          # Backup current .env
          if [ -f .env ]; then
            BACKUP_FILE=".env.backup.$(date +%Y%m%d_%H%M%S)"
            cp .env "$BACKUP_FILE"
            echo "‚úÖ Backed up .env to $BACKUP_FILE"
          fi
          
          # Create .env with production secrets
          cat > .env << 'ENVEOF'
          DOCKER_USERNAME=${{ secrets.DOCKER_USERNAME }}
          TUNNEL_TOKEN=${{ secrets.TUNNEL_TOKEN }}
          DB_USER=${{ secrets.DB_USER }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_NAME=blitzduel
          FRONTEND_URL=${{ secrets.FRONTEND_URL }}
          BACKEND_URL=${{ secrets.BACKEND_URL }}
          BACKEND_WS_URL=${{ secrets.BACKEND_WS_URL }}
          IMAGE_TAG=latest
          GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          ENVEOF
          
          echo "‚úÖ Updated .env file"
          
          # Smart deployment - bara uppdatera vad som √§ndrats
          if [ "$BACKEND_CHANGED" = "true" ]; then
            echo "üóÑ Ensuring postgres is healthy first..."
            docker compose up -d postgres
            
            for i in {1..6}; do
              if docker exec blitzduel-postgres pg_isready -U ${{ secrets.DB_USER }} -d blitzduel 2>&1; then
                echo "‚úÖ Postgres is ready"
                break
              fi
              if [ $i -eq 6 ]; then
                echo "‚ùå Postgres failed to start"
                docker logs blitzduel-postgres --tail 50
                exit 1
              fi
              echo "‚è≥ Waiting for postgres... ($i/6)"
              sleep 5
            done
            
            echo "üê≥ Pulling backend image..."
            docker compose pull backend
            echo "üöÄ Restarting backend..."
            docker compose up -d --no-deps backend
            
            echo "‚è≥ Waiting for backend to be healthy..."
            BACKEND_HEALTHY=false
            for i in {1..20}; do
              if docker exec blitzduel-backend wget --no-verbose --tries=1 --spider http://localhost:8080/actuator/health 2>&1; then
                echo "‚úÖ Backend is healthy after $((i*5)) seconds"
                BACKEND_HEALTHY=true
                break
              fi
              echo "‚è≥ Attempt $i/20 - waiting 5 more seconds..."
              sleep 5
            done
            
            if [ "$BACKEND_HEALTHY" = false ]; then
              echo "‚ùå Backend health check failed after 100 seconds"
              docker logs blitzduel-backend --tail 100
              exit 1
            fi
          else
            echo "‚è≠Ô∏è  Backend unchanged, skipping..."
          fi
          
          if [ "$FRONTEND_CHANGED" = "true" ]; then
            echo "üê≥ Pulling frontend image..."
            docker compose pull frontend
            echo "üöÄ Restarting frontend..."
            docker compose up -d --no-deps frontend
            
            echo "‚è≥ Waiting for frontend to be healthy..."
            FRONTEND_HEALTHY=false
            for i in {1..10}; do
              if docker exec blitzduel-frontend wget --no-verbose --tries=1 --spider http://localhost:80/health 2>&1; then
                echo "‚úÖ Frontend is healthy after $((i*5)) seconds"
                FRONTEND_HEALTHY=true
                break
              fi
              echo "‚è≥ Attempt $i/10 - waiting 5 more seconds..."
              sleep 5
            done
            
            if [ "$FRONTEND_HEALTHY" = false ]; then
              echo "‚ùå Frontend health check failed after 50 seconds"
              docker logs blitzduel-frontend --tail 100
              exit 1
            fi
          else
            echo "‚è≠Ô∏è  Frontend unchanged, skipping..."
          fi
          
          # Cloudflare och Postgres k√∂rs alltid (om de inte redan k√∂rs)
          echo "üîÑ Ensuring postgres and cloudflared are running..."
          docker compose up -d postgres cloudflared
          
          # Cleanup old images
          echo "üßπ Cleaning up old images..."
          docker image prune -af --filter "until=48h"
          
          echo "‚ú® Deployment completed successfully!"
          echo "üìä Current status:"
          docker compose ps

  # ==========================================
  # Notify Deployment Status
  # ==========================================
  notify:
    name: Notify Status
    runs-on: self-hosted
    needs: [deploy]
    if: always()
    steps:
      - name: Check deployment status
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "‚úÖ Deployment to production was SUCCESSFUL!"
            echo "üöÄ Application is now live"
          else
            echo "‚ùå Deployment FAILED!"
            echo "‚ö†Ô∏è Check logs for details"
            exit 1
          fi