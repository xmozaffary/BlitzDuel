name: Deploy to Production

on:
  push:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
      - 'LICENSE'
  workflow_dispatch:

env:
  REGISTRY: docker.io
  IMAGE_TAG: ${{ github.sha }}

jobs:
  # ==========================================
  # Detect Changes - Bygg bara vad som Ã¤ndrats
  # ==========================================
  detect-changes:
    name: Detect Changes
    runs-on: self-hosted
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check for changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            backend:
              - 'apps/backend/**'
              - '**/pom.xml'
            frontend:
              - 'apps/frontend/**'
              - '**/package.json'
              - '**/vite.config.ts'

  # ==========================================
  # Build Backend
  # ==========================================
  build-backend:
    name: Build Backend
    runs-on: self-hosted
    needs: detect-changes
    if: needs.detect-changes.outputs.backend == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'
      
      - name: Build with Maven
        run: |
          cd apps/backend/blitzduel
          ./mvnw clean package -DskipTests -B
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: ./apps/backend/blitzduel
          push: true
          platforms: linux/arm64
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/blitzduel-backend:latest
            ${{ secrets.DOCKER_USERNAME }}/blitzduel-backend:${{ env.IMAGE_TAG }}
          cache-from: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/blitzduel-backend:buildcache
          cache-to: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/blitzduel-backend:buildcache,mode=max

  # ==========================================
  # Build Frontend
  # ==========================================
  build-frontend:
    name: Build Frontend
    runs-on: self-hosted
    needs: detect-changes
    if: needs.detect-changes.outputs.frontend == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: apps/frontend/blitzduel/package-lock.json
      
      - name: Install dependencies
        run: |
          cd apps/frontend/blitzduel
          npm ci
      
      - name: Build application
        run: |
          cd apps/frontend/blitzduel
          npm run build
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: ./apps/frontend/blitzduel
          push: true
          platforms: linux/arm64
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/blitzduel-frontend:latest
            ${{ secrets.DOCKER_USERNAME }}/blitzduel-frontend:${{ env.IMAGE_TAG }}
          cache-from: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/blitzduel-frontend:buildcache
          cache-to: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/blitzduel-frontend:buildcache,mode=max

  # ==========================================
  # Deploy to Production
  # ==========================================
  deploy:
    name: Deploy to Raspberry Pi
    runs-on: self-hosted
    needs: [detect-changes, build-backend, build-frontend]
    if: always() && !failure() && !cancelled()
    env:
      BACKEND_CHANGED: ${{ needs.detect-changes.outputs.backend }}
      FRONTEND_CHANGED: ${{ needs.detect-changes.outputs.frontend }}
    steps:
      - name: Deploy
        run: |
          set -e
          
          cd ~/blitzduel
          
          # Set IMAGE_TAG to latest explicitly
          export IMAGE_TAG=latest
          
          echo "ğŸ“¦ Starting deployment..."
          echo "Backend changed: $BACKEND_CHANGED"
          echo "Frontend changed: $FRONTEND_CHANGED"
          
          # Backup current .env
          if [ -f .env ]; then
            BACKUP_FILE=".env.backup.$(date +%Y%m%d_%H%M%S)"
            cp .env "$BACKUP_FILE"
            echo "âœ… Backed up .env to $BACKUP_FILE"
          fi
          
          # Create .env with production secrets
          cat > .env << 'ENVEOF'
          DOCKER_USERNAME=${{ secrets.DOCKER_USERNAME }}
          TUNNEL_TOKEN=${{ secrets.TUNNEL_TOKEN }}
          DB_USER=${{ secrets.DB_USER }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_NAME=blitzduel
          FRONTEND_URL=${{ secrets.FRONTEND_URL }}
          BACKEND_URL=${{ secrets.BACKEND_URL }}
          BACKEND_WS_URL=${{ secrets.BACKEND_WS_URL }}
          IMAGE_TAG=latest
          ENVEOF
          
          echo "âœ… Updated .env file"
          
          # Smart deployment - bara uppdatera vad som Ã¤ndrats
          if [ "$BACKEND_CHANGED" = "true" ]; then
            echo "ğŸ³ Pulling backend image..."
            docker compose pull backend
            echo "ğŸš€ Restarting backend..."
            docker compose up -d --no-deps backend
            
            echo "â³ Waiting for backend to be healthy..."
            sleep 30
            
            if docker exec blitzduel-backend wget --no-verbose --tries=3 --spider http://localhost:8080/actuator/health 2>&1; then
              echo "âœ… Backend is healthy"
            else
              echo "âŒ Backend health check failed"
              docker logs blitzduel-backend --tail 50
              exit 1
            fi
          else
            echo "â­ï¸  Backend unchanged, skipping..."
          fi
          
          if [ "$FRONTEND_CHANGED" = "true" ]; then
            echo "ğŸ³ Pulling frontend image..."
            docker compose pull frontend
            echo "ğŸš€ Restarting frontend..."
            docker compose up -d --no-deps frontend
            
            echo "â³ Waiting for frontend to be healthy..."
            sleep 15
            
            if docker exec blitzduel-frontend wget --no-verbose --tries=3 --spider http://localhost:80/health 2>&1; then
              echo "âœ… Frontend is healthy"
            else
              echo "âŒ Frontend health check failed"
              docker logs blitzduel-frontend --tail 50
              exit 1
            fi
          else
            echo "â­ï¸  Frontend unchanged, skipping..."
          fi
          
          # Cloudflare och Postgres kÃ¶rs alltid (om de inte redan kÃ¶rs)
          echo "ğŸ” Ensuring postgres and cloudflared are running..."
          docker compose up -d postgres cloudflared
          
          # Cleanup old images
          echo "ğŸ§¹ Cleaning up old images..."
          docker image prune -af --filter "until=48h"
          
          echo "âœ¨ Deployment completed successfully!"
          echo "ğŸ“Š Current status:"
          docker compose ps

  # ==========================================
  # Notify Deployment Status
  # ==========================================
  notify:
    name: Notify Status
    runs-on: self-hosted
    needs: [deploy]
    if: always()
    steps:
      - name: Check deployment status
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "âœ… Deployment to production was SUCCESSFUL!"
            echo "ğŸš€ Application is now live"
          else
            echo "âŒ Deployment FAILED!"
            echo "âš ï¸ Check logs for details"
            exit 1
          fi
